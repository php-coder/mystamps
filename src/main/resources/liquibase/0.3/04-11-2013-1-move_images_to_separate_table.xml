<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
		xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
	
	<changeSet id="create-images-data-table" author="php-coder" context="scheme">
		<comment>Creates new table for holding images' content (#132)</comment>
		
		<createTable tableName="images_data">
			<column name="id" type="INT" autoIncrement="true">
				<constraints primaryKey="true" primaryKeyName="images_data_pk" />
			</column>
			<column name="content" type="LONGBLOB">
				<constraints nullable="false" />
			</column>
			<column name="image_id" type="INT">
				<constraints nullable="false" references="images" foreignKeyName="images_data_to_images_fk" />
			</column>
		</createTable>
		
		<modifySql dbms="mysql">
			<append value=" ENGINE=InnoDB" />
			
			<!-- Workaround for: https://liquibase.jira.com/browse/CORE-891 -->
			<regExpReplace replace="(REFERENCES \w+)" with="$1(id)" />
		</modifySql>
		
		<modifySql dbms="h2">
			<!-- Workaround for: https://liquibase.jira.com/browse/CORE-1288 -->
			<replace replace="VARBINARY" with="BLOB" />
		</modifySql>
		
	</changeSet>
	
	<changeSet id="move-images-to-separate-table" author="php-coder" context="data">
		<comment>Move images' content to the new table (#132)</comment>
		
		<sql>
			INSERT INTO images_data(image_id, content)
			SELECT id, data
			FROM images;
		</sql>
		
	</changeSet>
	
	<changeSet id="drop-images-data-column" author="php-coder" context="scheme">
		<comment>Drops unused column with images' content (#132)</comment>
		
		<dropColumn tableName="images" columnName="data" />
		
		<rollback>
			<addColumn tableName="images">
				<column name="data" type="LONGBLOB" />
			</addColumn>
			<sql>
				UPDATE images i
				JOIN images_data d
				ON i.id = d.image_id
				SET i.data = d.content;
			</sql>
			<addNotNullConstraint tableName="images" columnName="data" />
		</rollback>
		
	</changeSet>
	
</databaseChangeLog>
