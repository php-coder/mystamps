---

- name: Updating permissions on /data/logs
  file:
    path: /data/logs
    group: nginx
    mode: '0775'
    state: directory

- name: Creating /data/nginx
  file:
    path: /data/nginx
    owner: root
    group: root
    mode: '0755'
    state: directory

- name: Uploading configuration files
  copy:
    src: "../../src/main/config/nginx/{{ item }}"
    dest: "/etc/nginx/conf.d/{{ item }}"
    force: yes
    backup: no
    owner: root
    group: root
    mode: '0644'
  with_items:
  - mystamps-http.conf
  - mystamps-ssl.conf
  notify:
  - Restarting nginx service

- name: Uploading data files
  copy:
    src: "../../src/main/config/nginx/{{ item }}"
    dest: "/data/nginx/{{ item }}"
    force: yes
    backup: no
    owner: root
    group: root
    mode: '0644'
  with_items:
  - 503.en.html
  - 503.ru.html
  notify:
  - Restarting nginx service

# Self-signed certificate was generated by the following commands:
# openssl genrsa -out my-stamps.ru.key 2048
# openssl req -new -x509 -key my-stamps.ru.key -out my-stamps.ru.crt -days 3650 -subj /CN=my-stamps.ru
#
# For uploading production certificate put the files into mystamps-nginx/files/prod directory.
- name: Uploading certificate (.key file)
  copy:
    src: "{{ item }}"
    dest: "/etc/ssl/{{ item | basename }}"
    force: yes
    backup: no
    owner: root
    group: nginx
    mode: '0640'
  with_first_found:
  - prod/my-stamps.ru.key
  - my-stamps.ru.key
  notify:
  - Restarting nginx service

- name: Uploading certificate (.crt file)
  copy:
    src: "{{ item }}"
    dest: "/etc/ssl/{{ item | basename }}"
    force: yes
    backup: no
    owner: root
    group: nginx
    mode: '0640'
  with_first_found:
  - prod/my-stamps.ru.crt
  - my-stamps.ru.crt
  notify:
  - Restarting nginx service

- name: Running nginx
  service:
    name: nginx
    state: started
